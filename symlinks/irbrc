require 'pp'
require 'rubygems'
require 'irb/completion'
require 'irb/ext/save-history'

IRB.conf[:AUTO_INDENT]  = true
IRB.conf[:HISTORY_FILE] = File.expand_path('~/.irb-save-history')
IRB.conf[:PROMPT_MODE]  = :SIMPLE
IRB.conf[:SAVE_HISTORY] = 1000
IRB.conf[:USE_READLINE] = true

def copy(data)
  File.popen('pbcopy', 'w') { |p| p << data.to_s }
  $?.success?
end

def count_queries
  queries = 0
  subscriber = ActiveSupport::Notifications.subscribe('sql.active_record') do |*args|
    event = ActiveSupport::Notifications::Event.new(*args)
    if event.payload[:name] != 'SCHEMA'
      queries += 1
    end
  end
  retval = yield
  puts "QUERIES: #{queries}"
  retval
ensure
  ActiveSupport::Notifications.unsubscribe(subscriber)
end
